# Daily Log - 2026-01-26

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** Phase 1 - V1.0 Development
**Sprint:** Week 2 - Backend API + Data Layer
**Session Duration:** [to be filled]

---

## Summary

[To be completed at /closeday]

---

## Work Completed

### 1. Fixed Railway Custom Domain Documentation

Corrected DNS setup instructions across all documentation. Railway custom domains require:
1. Add domain in Railway dashboard first
2. Railway provides unique CNAME target (e.g., `j65ghs38.up.railway.app`)
3. Use Railway-provided target in DNS CNAME record

Previous incorrect documentation pointed CNAME directly to app URL.

### 2. Added Senior Specialist Role Rules

Updated CLAUDE.md to ensure Claude always acts as senior specialist in ALL roles:
- Never asks naked technical questions
- Always presents options with pros/cons
- Always checks V2.0 roadmap before recommending
- Makes decisions easy (Yes/No or A/B choices)

Comprehensive role list added: PM, Architect, Backend, Frontend, Database, DevOps, Search, Design, Security, QA, Data, AI/ML.

### 3. Added Coding Standards & Patterns (from everything-claude-code)

Researched and adopted best practices from Anthropic hackathon winner's repository:

**Added to CLAUDE.md:**
- **Coding Standards:** TypeScript patterns, immutability, error handling, async/await
- **PostgreSQL/Supabase Patterns:** Index cheat sheet, query optimization, RLS patterns, N+1 prevention
- **Security Checklist:** Pre-commit checks, secret management, input validation
- **Code Review Standards:** Priority-based review checklist
- **API Design Standards:** REST conventions, response format, error handling

### 4. FastAPI Backend Setup (Week 2 - Day 1)

Created FastAPI project in `/backend`:

| Component | File | Status |
|-----------|------|--------|
| Main app | `app/main.py` | ✅ |
| Config | `app/config.py` | ✅ |
| Health endpoint | `app/api/v1/health.py` | ✅ |
| Module endpoints | `app/api/v1/modules.py` | ✅ (placeholder) |
| Requirements | `requirements.txt` | ✅ |
| Railway config | `railway.toml` | ✅ |

**API Endpoints Created:**
- `GET /` - API info
- `GET /health` - Health check
- `GET /api/v1/health` - Detailed health with DB connection test
- `GET /api/v1/modules` - List modules
- `GET /api/v1/modules/{module}` - Get aggregated module data (WORKING)
- `GET /api/v1/modules/{module}/{primary_value}/details` - Row details (WORKING)

### 5. Backend Deployed to Railway

- Service: `rijksuitgaven-api`
- URL: `https://rijksuitgaven-api-production-3448.up.railway.app`
- Health: `/health` - connected to Supabase
- Docs: `/docs` - Swagger UI

### 6. Database Connection Issues Resolved

| Issue | Solution |
|-------|----------|
| Tenant not found | Wrong region: `aws-0` → `aws-1` |
| Database not found | Trailing whitespace in DATABASE_URL |
| RLS blocking queries | Added postgres role policies |

### 7. Real Aggregation Queries Implemented

Instrumenten endpoint working with real data:
- 221,362 unique recipients
- Year columns 2016-2024
- Search, pagination, sorting working
- **Performance issue:** 9-19 seconds (target: <500ms)

### 8. Documentation Audit Completed

| Item | Status | Notes |
|------|--------|-------|
| Backend README URL | ✅ Fixed | Was TBD, now has actual Railway URL |
| Sprint plan table name | ✅ Fixed | `/api/v1/stad` → `/api/v1/gemeente` |
| SESSION-CONTEXT.md | ✅ Updated | Week 2 progress, FastAPI infrastructure |
| Database documentation | ✅ Complete | Indexes documented |

### 9. Query Performance Optimization

**Problem:** Aggregation queries took 9-19 seconds (target: <500ms)

**Root Cause:** GROUP BY on 674K rows requires full table scan even with index

**Solution:** Created materialized views (pre-computed aggregations) for all 6 modules:

| View | Source Table | Primary Field |
|------|--------------|---------------|
| `instrumenten_aggregated` | instrumenten | ontvanger |
| `apparaat_aggregated` | apparaat | kostensoort |
| `inkoop_aggregated` | inkoop | leverancier |
| `provincie_aggregated` | provincie | ontvanger |
| `gemeente_aggregated` | gemeente | ontvanger |
| `publiek_aggregated` | publiek | ontvanger |

**Performance Results:**

| Module | Before | After | Improvement |
|--------|--------|-------|-------------|
| instrumenten | 13s | **114ms** | 100x faster |
| apparaat | - | **172ms** | - |
| inkoop | - | **567ms** | - |
| provincie | - | **196ms** | - |
| gemeente | - | **191ms** | - |
| publiek | - | **222ms** | - |
| integraal | - | **989ms** | - |

### 10. Amount Normalization

Implemented consistent absolute euro amounts across all modules:
- instrumenten & apparaat: Multiply by 1000 (source in ×1000)
- Other modules: No change (already absolute euros)
- All API responses now return amounts in absolute euros

---

## Files Created

| File | Description |
|------|-------------|
| `backend/` | FastAPI project directory |
| `backend/app/main.py` | FastAPI application entry point |
| `backend/app/config.py` | Environment configuration |
| `backend/app/api/v1/health.py` | Health check endpoints |
| `backend/app/api/v1/modules.py` | Module data endpoints |
| `backend/requirements.txt` | Python dependencies |
| `backend/railway.toml` | Railway deployment config |
| `backend/README.md` | Backend documentation |
| `backend/app/services/database.py` | asyncpg connection pool |
| `backend/app/services/modules.py` | Aggregation query service |
| `scripts/sql/005-backend-rls-policy.sql` | RLS policies for backend |
| `scripts/sql/006-aggregated-materialized-views.sql` | Pre-computed aggregation views |

## Files Modified

| File | Changes |
|------|---------|
| `CLAUDE.md` | Added Senior Specialist roles, Coding Standards, PostgreSQL Patterns, Security Checklist, Code Review Standards, API Design Standards |
| `logs/daily/2026-01-24.md` | Fixed DNS setup instructions to show correct Railway custom domain process |
| `09-timelines/v1-sprint-plan.md` | Updated Day 0 DNS setup, fixed `/api/v1/stad` → `/api/v1/gemeente` |
| `07-migration-strategy/deployment-strategy.md` | Updated DNS Records Reference and setup instructions |
| `backend/README.md` | Updated Railway URL (was TBD) |
| `02-requirements/backlog.md` | Added inkoop/integraal performance optimization item |
| `04-target-architecture/RECOMMENDED-TECH-STACK.md` | Updated Tremor → Recharts |
| `docs/LOCAL-SETUP.md` | Updated chart library decision |
| `logs/SESSION-CONTEXT.md` | Updated V2-Ready Architecture, executed scripts |
| `scripts/sql/DATABASE-DOCUMENTATION.md` | Added aggregated materialized views section |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Railway DNS docs incorrect | Updated all docs to show correct process: add domain in Railway first, then use Railway-provided CNAME target |
| Supabase region wrong | `aws-0-eu-west-1` → `aws-1-eu-west-1` |
| DATABASE_URL whitespace | Removed trailing spaces |
| RLS blocking backend | Added `postgres` role policies for all tables |
| SQL params not passed | Fixed params handling when no filters applied |
| Query performance 9-19s | Created materialized views → 114-989ms |
| integraal missing row_count | Use source_count instead (column doesn't exist in universal_search) |
| Amount units inconsistent | API now normalizes all amounts to absolute euros |

---

## Next Steps

[To be completed at /closeday]

---

**Session Status:** In Progress
