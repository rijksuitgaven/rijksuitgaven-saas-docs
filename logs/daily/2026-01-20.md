# Daily Log - 2026-01-20

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Scope Redefinition
**Session Duration:** Morning

---

## Summary

**Major scope change:** V1.0 is now a **technology port** of the current system to the new stack, plus the new search features. This creates a future-proof foundation for V2.0 Research Mode.

---

## Key Decision: V1.0 Scope Change

### Previous V1.0 Scope
- New search features only
- New UI designs (wireframes)

### New V1.0 Scope

| Category | Description |
|----------|-------------|
| **Technology Port (1:1)** | Replicate current rijksuitgaven.nl functionality exactly |
| **New Features** | Global search, autocomplete, cross-module search, enhanced filters, CSV export |
| **Tech Stack** | Next.js + Supabase + Meilisearch |

### Rationale
- Creates stable foundation before adding new features
- Reduces risk by separating "port" from "new"
- Allows existing users to migrate without learning new UI
- Future-proof architecture for V2.0 Research Mode

---

## Technical Discovery: Two-View Toggle

The current system has a UI toggle between two views, each backed by different SQL tables:

| View | SQL Pattern | Data Structure |
|------|-------------|----------------|
| **Geconsolideerd op ontvanger** | `*_pivot_geconsolideerd` | Aggregated rows, multiple values joined with `<br>` |
| **Uitgebreid zoeken met filters** | `*_pivot` | Individual line items, filterable |

### Table Mappings Per Module

| Module | Consolidated Table | Detail Table |
|--------|-------------------|--------------|
| Apparaatsuitgaven | `apparaat_pivot_geconsolideerd` | `apparaat_pivot` |
| Inkoopuitgaven | `inkoop_pivot_geconsolideerd` | `inkoop_pivot` |
| Financiële Instrumenten | `instrumenten_pivot_geconsolideerd` | `instrumenten_pivot` |
| Provinciale subsidies | `provincie_pivot_geconsolideerd` | `provincie_pivot` |
| Gemeentelijke subsidies | `stad_pivot_geconsolideerd` | `stad_pivot` |
| Publiek | `publiek_pivot_geconsolideerd` | `publiek_pivot` |
| Integraal | `universal_search` | (cross-module) |

### Key Observations

**Consolidated tables (`*_pivot_geconsolideerd`):**
- Group by `Kostensoort` (recipient)
- Concatenate related values with `<br>` for display
- Include `row_count` (number of underlying records)
- Include computed `year_count` (years with non-zero data)

**Detail tables (`*_pivot`):**
- One row per record
- Individual year columns (2016-2024)
- Filterable by all fields
- `Totaal` column for row sum

---

## Files Modified

| File | Changes |
|------|---------|
| `CLAUDE.md` | Updated V1.0 scope to include tech port |
| `logs/SESSION-CONTEXT.md` | Updated with new scope, architecture decisions |
| `04-target-architecture/RECOMMENDED-TECH-STACK.md` | Major update: Supabase, Typesense, pgvector strategy |
| `03-current-state/current-ui-overview.md` | Added two-view toggle pattern with SQL mappings |

## Files Created

| File | Description |
|------|-------------|
| `logs/daily/2026-01-20.md` | This daily log |
| `08-decisions/ADR-013-search-semantic-architecture.md` | Search and semantic architecture decision |
| `03-current-state/v1-port-specification.md` | Comprehensive V1.0 port specification |

## Web Archives Received

18 HTML pages covering all modules and both views:
- Home (logged in/out), Login
- All 7 modules with Geconsolideerd and Uitgebreid views
- Support, Over ons pages

---

## Architecture Decisions (ADR-013)

### Search & Semantic Architecture

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Database | Supabase (PostgreSQL) | pgvector included, Auth built-in, easy setup |
| Keyword Search | Typesense | <50ms autocomplete, typo tolerance, 500K+ scale |
| Vector Search | pgvector (V2.0 only) | Only ~2-5K vectors needed |
| Semantic Strategy | IBOS domain classification | 500K recipients → 30 domains (free lookup) |
| AI | Claude (sparingly) | Only for complex reasoning, cache aggressively |
| Data Sync | Nightly rebuild | Supabase → Typesense, fits monthly data updates |

### Cost Estimate

| Service | Monthly |
|---------|---------|
| Supabase Pro | €25 |
| Railway (Next.js, FastAPI, Typesense, Redis) | €52-85 |
| Claude (V2.0, cached) | €20-40 |
| **Total** | **€97-150** |

Budget: €180/month → Buffer: €30-83

---

## Next Steps

1. **Receive web archives** - User exporting current UI pages
2. **Document port requirements** - Detailed spec of what to replicate
3. **Create port specification** - Module-by-module requirements
4. **MySQL → Supabase migration plan** - Data migration strategy

---

## Pending: Web Archives

User will export web archives of current UI to:
```
rijksuitgaven-saas-docs/03-current-state/web-archives/
```

Suggested captures per module:
1. Default view (Geconsolideerd)
2. Switched to Uitgebreid with filters
3. Any expanded/detail states

---

## Notes

### Impact on Previous Work
- Batch 1 wireframes remain valid for **new features**
- Need to document **current UI** for port (web archives will help)
- Wireframe batches 2-5 may need adjustment

### V1.0 Deliverables (Updated)
1. Technology port of current system
2. New global search bar
3. New cross-module search
4. Enhanced filters
5. CSV export (500 rows)
6. Magic Link auth on new stack

---

## Brainstorm Session: Single-View Architecture

### The Problem
The two-view toggle ("Geconsolideerd" vs "Uitgebreid") exists because of pre-computed pivot tables, not user needs.

### Key Insights
1. **Users want patterns** - They know topics (Infrastructure, Environment), not recipient names
2. **Source data is transactional** - One row per payment, aggregation can be done on-the-fly
3. **Toggle = database limitation** - Not a UX requirement

### Decision: ADR-014
Build a **single smart view** with:
- Year columns always visible (trend analysis)
- Aggregated by recipient by default
- Click to expand → grouped sub-rows
- User-selectable grouping (Regeling, Artikel, etc.)
- "Show all rows" for raw data

### Impact
| Aspect | Before | After |
|--------|--------|-------|
| Tables | 20+ (pivots) | 7 (source only) |
| Toggle | Required | Eliminated |
| Data sync | Complex | Simple |
| Flexibility | Fixed views | Dynamic grouping |

### Files Created
- `08-decisions/ADR-014-single-view-architecture.md`
- `03-current-state/source-data-analysis.md`
- `02-requirements/cross-module-requirements.md`
- `02-requirements/backlog.md`
- `02-requirements/overzicht-page-requirements.md`
- `02-requirements/marketing-pages-requirements.md`

### Files Updated
- `CLAUDE.md` - Added solo founder context, updated V1.0 scope

---

## Brainstorm Session: Cross-Module Architecture

### Decisions Made

| Topic | Decision |
|-------|----------|
| Apparaatsuitgaven | Separate module, NOT in cross-module (no recipients) |
| Included modules | instrumenten, gemeente, provincie, publiek, inkoop |
| Results display | Recipient → Module breakdown (with year columns) |
| Totals row | YES - grand total across all modules |
| Navigation | Click grouping → module page with filter applied |
| Data source | Keep aggregated table (handles EUR normalization) |
| Recipient normalization | V1.0: `UPPER()`, V2.0: entity mapping table |

### URL Sharing
- V1.0: Basic (search term, module, key filters)
- V2.0: Full state restoration

### Backlog Items Added
- Entity resolution / recipient normalization
- Download screenshot feature
- Full URL state restoration
- Inzichten / Self-Service BI

---

## Brainstorm Session: Overzicht Page

### Decision
Add dedicated "Overzicht" page showing module-level totals - V1.0 feature.

### Features
| Feature | Detail |
|---------|--------|
| Module totals | All 6 modules with year columns |
| Sub-sources | Publiek (RVO/COA/NWO), Provincies, Gemeentes |
| Gemeentes limit | Top 10 + "Toon alle X gemeentes" |
| Navigation | Click module/sub-source → module page with filter |
| Data | Pre-computed `module_totals` table |
| Grand total | Footer row with totals across all modules |

### Totals Calculation Decision
- Row totals: Backend (SQL)
- Column totals (footer): Frontend (visible rows only)

---

## Brainstorm Session: Marketing Pages

### Decision
No CMS - build marketing pages as simple Next.js components.

### Rationale
| Factor | Implication |
|--------|-------------|
| Solo founder | No time for multiple systems |
| Content changes | Infrequent |
| Technical founder | Can edit code directly |
| WordPress slow | Don't keep it |

### Pages Defined
- Homepage (port from WordPress)
- Pricing
- Support (markdown files)
- About
- Contact
- Demo booking
- Login
- Terms/Privacy

### Build Approach
- v0.dev for UI generation
- Claude Code for logic/integration
- Direct file editing for content changes

---

## Brainstorm Session: V2.0 Vision

### Tagline
"The Bloomberg Terminal for Rijksfinancien"

### Target Audience
- Political parties (budget for research)
- Well-funded media organizations
- Consultancies

### Core Feature Pillars

| Pillar | Description |
|--------|-------------|
| **Follow the Money to People** | Company profiles, board of directors, people connections via KvK |
| **My Government Priorities** | User-defined focus areas, spending alignment view |
| **Trends & Visual Reports** | Built-in trend analysis, publication-ready charts |
| **Connected Data** | Wet ↔ Regeling mapping, legislation context |
| **Alternative Budget Builder** | PR/marketing feature - create shareable alternative budgets |

### Pricing Strategy
| Tier | Price |
|------|-------|
| Professional (V1.0) | €150/mo |
| Research (V2.0) | €350/mo |
| Newsroom | €800/mo |
| Political | €1,500/mo |

### Data Sources to Integrate
- KvK Handelsregister (API)
- wetten.overheid.nl (scraping)
- rijksfinancien.nl (scraping)
- Kamerstukken (API)

### Document Created
`02-requirements/v2-vision-roadmap.md`

---

## Brainstorm Session: V2.0 "Terminal" UI

### Key Decisions

| Decision | Outcome |
|----------|---------|
| UI paradigm | Guided Research Assistant (hybrid) |
| Entry point | Topic-first (policy domains), not search box |
| AI behavior | **Factual only, NO opinions** |
| Visualizations | Pre-built, one-click (users don't build) |
| Workflow | "Add to dossier" collection model |
| Dossier persistence | Save forever |
| Export branding | "Powered by Rijksuitgaven" watermark |

### User Flow
1. Choose topic (domain tiles or search)
2. AI shows overview + suggests next steps
3. One-click deep dive into recipients/profiles
4. Collect findings in dossier
5. Export for debates/articles

### AI Rules (Critical)
- Present facts only
- Never interpret or give opinions
- User draws their own conclusions

---

## Technical Architecture Review: V2-Ready Stack

### Decision
Design V1 infrastructure to support V2 without platform migrations.

### Final Frontend Stack
| Component | Library |
|-----------|---------|
| UI Components | shadcn/ui |
| Charts | Tremor |
| Tables | TanStack Table v8 |
| Forms | React Hook Form + Zod |
| State | TanStack Query |
| Maps (V2) | react-map-gl |
| PDF (V2) | Puppeteer |

### V2-Ready Database
- All V2 tables created empty in V1
- pgvector extension enabled
- Feature flags control functionality
- No schema migrations between V1 and V2

### Documents Updated
- `04-target-architecture/RECOMMENDED-TECH-STACK.md` (major update)

---

---

## Project Overview Update

Updated all `01-project-overview` files with actual project information:

| File | Status |
|------|--------|
| `project-charter.md` | ✅ Populated with vision, scope, constraints, risks, budget, timeline |
| `stakeholders.md` | ✅ Updated with solo founder context, AI roles, RACI matrix |
| `success-criteria.md` | ✅ Filled with specific metrics (100ms search, €180 budget, etc.) |
| `development-methodology.md` | Already complete (AI-assisted development model) |

---

## Development Readiness Assessment

### Pre-Development Questions Resolved

| Question | Answer |
|----------|--------|
| User migration | 50 users, Magic Link auth |
| Data export | Confirmed available |
| Payment history | Not needed (fresh start) |
| Auth method | Magic Link (passwordless) |

### Database Analysis

| Category | Tables | Rows | Size |
|----------|--------|------|------|
| Source tables (needed) | 7 | ~1.5M | ~700 MB |
| Pivot tables (NOT needed) | 14 | ~2.3M | ~800 MB |
| Cross-module | 2 | ~1.9M | ~450 MB |
| **Total needed** | **9** | **~3.4M** | **~1.2 GB** |

---

## Sprint Plan Created

**File:** `09-timelines/v1-sprint-plan.md`

| Week | Focus |
|------|-------|
| 0 | Account setup (Supabase, Railway) |
| 1 | Infrastructure + Data migration |
| 2 | Backend API + Data layer |
| 3 | Core UI components |
| 4 | Module pages |
| 5 | Search + Navigation |
| 6 | Auth + Overzicht |
| 7 | Marketing pages |
| 8 | Launch |

### Working Mode

- Solo founder decides and executes immediately
- 2-4 hours daily dedication
- Claude writes code, provides commands
- Founder executes, tests, decides

---

## Files Created

| File | Description |
|------|-------------|
| `09-timelines/v1-sprint-plan.md` | 8-week sprint plan with daily tasks |

## Files Updated

| File | Changes |
|------|---------|
| `CLAUDE.md` | Added Working Mode section, Magic Link auth, sprint reference |
| `logs/SESSION-CONTEXT.md` | Updated phase, next steps with account setup |

---

---

## Documentation Audit (End of Day)

### Files Deleted (14 empty templates)

| Folder | Files |
|--------|-------|
| 02-requirements | business-requirements.md, functional-requirements.md, user-stories.md |
| 04-target-architecture | system-architecture.md, data-architecture.md |
| 06-technical-specs | tech-stack.md, auth-specifications.md, api-specifications.md, database-schema.md, performance-requirements.md, monitoring-logging.md |
| 07-migration-strategy | data-migration-plan.md, customer-migration-plan.md, rollback-strategy.md, testing-strategy.md |

### Files Updated (auth: email/password → Magic Link)

| File | Change |
|------|--------|
| CLAUDE.md | Auth constraint, Documentation Rules, Model Selection Policy, /closeday procedure |
| RECOMMENDED-TECH-STACK.md | Supabase auth method |
| project-charter.md | In Scope and Constraints |
| success-criteria.md | Security checklist and Feature Delivery |
| marketing-pages-requirements.md | Login page description |
| SESSION-CONTEXT.md | Product Decisions |
| v1-port-specification.md | Login page fields |
| search-requirements.md | Export limits (10K→500), added auth note |

### Files Consolidated

| File | Action |
|------|--------|
| 07-migration-strategy/migration-overview.md | Redirects to sprint plan |
| .claude/commands/closeday.md | Added documentation audit as Step 0 |

### Rules Added to CLAUDE.md

- Documentation Rules section (single source of truth)
- Model Selection Policy (detailed Haiku/Sonnet/Opus guidelines)
- /closeday procedure (references command file)

---

**Session Status:** Completed - READY TO START DEVELOPMENT
**Blockers:** None
**Next Action:** Create Supabase and Railway accounts

**Model Used:** Opus 4.5 (complex audit, cross-document analysis, project planning)
